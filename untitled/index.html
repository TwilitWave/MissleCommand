<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Shittier missile command</title>
    <script src="phaser.min.js"></script>
    <script src="phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">


    //  The in-bound missiles

    MissileLauncher = function (game, bmd, cities) {

        this.game = game;
        this.bmd = bmd;
        this.cities = cities;

        this.missiles = [];

        this.total = 15;
        this.speed = 150;

        return this;

    }

    MissileLauncher.prototype = {


        startWave: function (total, speed, starting) {

            this.total = total;
            this.speed = speed;

            this.launch(4, 0);

            this.game.time.events.add(4000, this.launch, this, 4, 0);
            this.game.time.events.add(4000, this.launch, this, 4, 250);

        },
        launch: function (qty, delay) {

            for (var i = 0; i < qty; i++)
            {
                this.getMissile().launch(this.cities.getRandom(), this.speed, delay);

                this.total--;

                if (this.total === 0)
                {
                    console.log('wave over');
                }
            }

        },

        getMissile: function () {

            for (var i = 0; i < this.missiles.length; i++)
            {
                if (this.missiles[i].alive === false)
                {
                    return this.missiles[i];
                }
            }

            //	Got this far? We need a new missile
            var missile = new Missile(this);

            this.missiles.push(missile);

            return missile;

        },

        update: function () {

            for (var i = 0; i < this.missiles.length; i++)
            {
                if (this.missiles[i].alive)
                {
                    this.missiles[i].update();
                }
            }

        },

        numAliveMissiles:function()
        {
            var temp = [];
            for(var i = 0; i < this.missiles.length;i++)
            {
                if(this.missiles[i].alive == true)
                {
                    temp.push(this.missiles[i]);
                }
            }
            return temp;
        },

        addExplosion: function (x, y) {

            //let explosion = new Explosion(this.game, this.explosionBMD);

            //this.getExplosion().explode(x, y);

        },
    }

    MissileLauncher.prototype.constructor = MissileLauncher;

    Missile = function (launcher) {

        this.launcher = launcher;
        this.game = launcher.game;
        this.bmd = launcher.bmd;

        this.destX = 0;
        this.destY = 0;

        this.line = new Phaser.Line();

        this.pending = true;
        this.alive = false;
        this.speed = 1000;

        this.target = null;
        this.data = null;
        this.index = 0;

        return this;

    }

    Missile.prototype = {

        launch: function (target, speed, delay) {

            if (delay > 0)
            {
                //	start timer here
            }

            this.target = target;

            var x = this.game.world.randomX;

            this.line.setTo(x, 0, x, 0);

            this.speed = Math.floor(this.game.math.distance(this.line.start.x, this.line.start.y, target.hitX, target.hitY) * speed);

            var tween = this.game.make.tween(this.line.end).to( { x: target.hitX, y: target.hitY }, this.speed, Phaser.Easing.Linear.None);

            this.data = tween.generateData(60);
            this.index = 0;

            this.line.end.set(this.data[this.index].x, this.data[this.index].y);

            this.alive = true;
            
        },

        update: function () {

            if (this.alive)
            {
                this.bmd.draw('enemymissile', this.data[this.index].x - 35, this.data[this.index].y - 15);
                
                this.index++;

                if (this.index === this.data.length)
                {
                    this.alive = false;
                }
                else
                {
                    this.line.end.x = this.data[this.index].x;
                    this.line.end.y = this.data[this.index].y;
                }

            }

        },


        explode:function()
        {
            this.alive = false;
        }

    };


    Object.defineProperty(Missile.prototype, "x", {

        get: function () {
            return this.line.end.x;
        }

    });

    Object.defineProperty(Missile.prototype, "y", {

        get: function () {
            return this.line.end.y;
        }

    });





    Missile.prototype.constructor = Missile;

    //	The rockets you fire at the missiles

    Rocket = function (game, bmd) {

        this.game = game;
        this.bmd = bmd;

        this.x = 0;
        this.y = 0;
        this.launchX = 0;
        this.launchY = 0;
        this.destX = 0;
        this.destY = 0;

        this.line = null;
        this.alive = false;
        this.speed = 10000;

        this.silo = null;
        this.data = null;
        this.index = 0;

        return this;

    }

    Rocket.prototype = {

        launch: function (silo, destX, destY, speed) {

            this.silo = silo;
            this.launchX = silo.launchX;
            this.launchY = silo.launchY;

            this.destX = destX;
            this.destY = destY;

            this.line = new Phaser.Line(this.launchX, this.launchY, this.launchX, this.launchY);

            this.speed = Math.floor(this.game.math.distance(this.line.start.x, this.line.start.y, destX, destY) * speed);

            let destination = { x: this.launchX, y: this.launchY };

            let tween = this.game.make.tween(destination).to( { x: this.destX, y: this.destY }, this.speed, Phaser.Easing.Linear.None);

            this.data = tween.generateData(60);
            this.index = 0;

            this.alive = true;
            
            
        },

        updateMyTween: function(demoTween,targetObject){
            demoTween.timeline[0].vStart={x:targetObject.x,y:targetObject.y};
            demoTween.timeline[0].duration=demoTween.timeline[0].duration-demoTween.timeline[0].dt;
            demoTween.timeline[0].vEnd={x:400,y:200};
            demoTween.timeline[0].dt=0;
        },


        update: function () {

            if (this.alive)
            {
                this.bmd.draw('target', this.destX - 20, this.destY - 20);
                this.bmd.draw('missile', this.data[this.index].x - 20, this.data[this.index].y - 20);

                this.index++;

                if (this.index === this.data.length)
                {
                    this.alive = false;
                    this.silo.addExplosion(this.line.end.x, this.line.end.y);
                }
                else
                {
                    this.line.end.x = this.data[this.index].x;
                    this.line.end.y = this.data[this.index].y;
                }
            }

        }

    };

    Rocket.prototype.constructor = Rocket;


    //	The resulting explosions

    Explosion = function (game, bmd) {

        this.game = game;
        this.bmd = bmd;

        this.x = 0;
        this.y = 0;
        this.circle;

        this.alive = false;
        this.maxRadius = 40;
        this.speed = 750;

        this.data = null;
        this.index = 0;

        return this;

    }

    Explosion.prototype = {

        explode: function (x, y) {

            this.circle = new Phaser.Circle(x, y, 1);

            //this.add.sprite(x, y, 'explosion');

            let tween = this.game.make.tween(this.circle).to( { radius: this.maxRadius }, this.speed, Phaser.Easing.Linear.None);
            tween.yoyo(true);
            tween.interpolation(game.math.catmullRomInterpolation);

            this.alive = true;

            this.data = tween.generateData(60);
            this.index = 0;

        },

        update: function () {

            if (this.alive)
            {
                this.bmd.context.fillStyle = '#ffff00';

                this.bmd.context.beginPath();
                this.bmd.context.arc(this.circle.x, this.circle.y, this.circle.radius, 0, Math.PI * 2, false);
                this.bmd.context.closePath();
                this.bmd.context.fill();

                this.index++;

                if (this.index === this.data.length)
                {
                    //for when the missile hits its point for the explosion to occur
                    this.alive = false;
                }
                else
                {
                    this.circle.radius = this.data[this.index].radius;
                }
            }

        },
        checkCollision: function (missiles) {
            for(var i = 0;i < missiles.length;i++)
            {
                if(this.circle.contains(missiles[i].x,missiles[i].y)&& missiles[i].alive)
                {
                    missiles[i].explode();

                }
            }

        }

    };

    Explosion.prototype.constructor = Explosion;




    City = function (game, x) {

        Phaser.Sprite.call(this, game, x, 1000, 'honey', 0);

        this.hitX = this.x + 32;
        this.hitY = this.y + 30;

        return this;

    }

    City.prototype = Object.create(Phaser.Sprite.prototype);
    City.prototype.constructor = City;

    GravityWell = function(game, x)
    {
        Phaser.Sprite.call(this,game,x,220,'gwell',0)

        this.hitX = this.x + 32;
        this.hitY = this.y + 30;

        return this;
    }

    GravityWell.prototype = Object.create(Phaser.Sprite.prototype);
    GravityWell.prototype.constructor = GravityWell;


    Silo = function (game, bmd1, bmd2, x) {

        this.game = game;

        this.rocketsBMD = bmd1;
        this.explosionBMD = bmd2;

        this.launchX = x;
        this.launchY = 900;

        this.armory = 15;

        this.rockets = [];
        this.explosions = [];

        return this;

    }

    Silo.prototype.constructor = Silo;

    Silo.prototype = {

        launch: function (x, y, speed) {

            if (this.armory > 0)
            {
                let rocket = new Rocket(this.game, this.rocketsBMD);

                this.rockets.push(rocket);

                rocket.launch(this, x, y, speed);
            }

        },

        addExplosion: function (x, y) {

            let explosion = new Explosion(this.game, this.explosionBMD);

            this.explosions.push(explosion);

            explosion.explode(x, y);

        },

        accelerateToObject:function(obj1, obj2, speed) {
            if (typeof speed === 'undefined') { speed = 60; }
            var angle = Math.atan2(obj2.y - obj1.y, obj2.x - obj1.x);
            obj1.body.rotation = angle + game.math.degToRad(90);  // correct angle of angry bullets (depends on the sprite used)
            obj1.body.force.x = Math.cos(angle) * speed;    // accelerateToObject
            obj1.body.force.y = Math.sin(angle) * speed;
        },

        update: function () {

            //this.game.physics.arcade.collide(this,missileLauncher);


            for (let i = 0; i < this.rockets.length; i++)
            {
                if (this.rockets[i].alive)
                {
                    this.rockets[i].update();
                }
            }

            for (let i = 0; i < this.explosions.length; i++)
            {
                if (this.explosions[i].alive)
                {
                    this.explosions[i].update();
                }
            }

        },

        checkCollision: function (missiles) {

            if (missiles.length === 0)
            {
                return;
            }

            for (var i = 0; i < this.explosions.length; i++)
            {
                if (this.explosions[i].alive)
                {
                    this.explosions[i].checkCollision(missiles);
                }
            }

        }

    }

    let game = new Phaser.Game(960, 1280, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create, update: update, render: render });

    function preload() {
              
        game.load.image('city', 'assets/foreground.png');
        game.load.image('missile', 'assets/shelbee.png');
        game.load.image('enemymissile', 'assets/wasp01.png');
        game.load.image('sky', 'assets/sky.png');
        game.load.spritesheet('explosion', 'assets/explosion.png', 128, 128);
        game.load.image('hives', 'assets/pixelbeehivehalf.png');
        game.load.image('honey', 'assets/TheLarvaShack_.png');
        game.load.image('target', 'assets/target.png');


        game.stage.smoothed = false;
    }

    let rocketsBitmap;
    let rocketsLayer;

    let explosionsBitmap;
    let explosionsLayer;

    let missilesBitmap;
    let missilesLayer;

    let missileLauncher;

    let land;
    let cities;
    let gravityWells;

    let gravitywell;

    let rocketSpeed = 5;

    let silo1;
    let silo2;

    function create() {


        game.add.image(0, 0, 'sky');
        

        rocketsBitmap = game.add.bitmapData(960, 1280);
        missilesBitmap = game.add.bitmapData(960, 1280);
        explosionsBitmap = game.add.bitmapData(960, 1280);

        rocketsLayer = game.add.image(0, 0, rocketsBitmap);
        missilesLayer = game.add.image(0, 0, missilesBitmap);
        explosionsLayer = game.add.image(0, 0, explosionsBitmap);

        land = game.add.image(0, 0, 'city');
        hives = game.add.image(0, 0, 'hives');

        cities = game.add.group();

        cities.add(new City(game, 200));
        cities.add(new City(game, 300));
        cities.add(new City(game, 400));
        cities.add(new City(game, 500));
        cities.add(new City(game, 600));
        cities.add(new City(game, 700));

        game.physics.startSystem(Phaser.Physics.P2JS);
        gravitywell = game.add.sprite(200,220,'gwell');
        game.physics.p2.enable(gravitywell);
        //gravitywell.body.immovable = true;


        silo1 = new Silo(game, rocketsBitmap, explosionsBitmap, 100);
        silo2 = new Silo(game, rocketsBitmap, explosionsBitmap, 860);
        game.physics.p2.enable(silo1, false);

        game.physics.p2.enable(silo2, false);


        missileLauncher = new MissileLauncher(game, missilesBitmap, cities);
        missileLauncher.startWave(1125,30,5);

        game.input.onDown.add(launchRocket, this);

    }

    function launchRocket(pointer) {


        if (pointer.x < 320)
        {
            silo1.launch(pointer.x, pointer.y, rocketSpeed);
        }
        else
        {
            silo2.launch(pointer.x, pointer.y, rocketSpeed);
        }

    }

    function accelerateToObject(obj1, obj2, speed) {
        if (typeof speed === 'undefined') { speed = 60; }
        var angle = Math.atan2(obj2.y - obj1.y, obj2.x - obj1.x);
        obj1.body.rotation = angle + game.math.degToRad(90);  // correct angle of angry bullets (depends on the sprite used)
        obj1.body.force.x = Math.cos(angle) * speed;    // accelerateToObject
        obj1.body.force.y = Math.sin(angle) * speed;
    }

    function update() {

        rocketsBitmap.clear();
        explosionsBitmap.clear();
        missilesBitmap.clear();

        silo1.update();
        silo2.update();

        //silo1.accelerateToObject(silo2,gravitywell,50);

        //gravityWells.update();

        missileLauncher.update();


        silo1.checkCollision(missileLauncher.numAliveMissiles());
        silo2.checkCollision(missileLauncher.numAliveMissiles());


    }

    function render()
    {

    }
</script>

</body>
</html>